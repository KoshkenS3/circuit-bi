import { ContractCallContext, ContractCallResults, Multicall } from "ethereum-multicall";
import { ethers } from "ethers";
import yargs from "yargs";
import { _createImportBehaviourFromCmdParams } from "../protocol/beefy/script/beefy";
import { defaultImportBehaviour } from "../protocol/common/types/import-context";
import { createRpcConfig, getMultipleRpcConfigsForChain } from "../protocol/common/utils/rpc-config";
import { allChainIds, Chain } from "../types/chain";
import { allSamplingPeriods, SamplingPeriod } from "../types/sampling";
import { BeefyVaultV6AbiInterface, ERC20AbiInterface } from "../utils/abi";
import { getBeefyMulticallAddress } from "../utils/addressbook";
import { rootLogger } from "../utils/logger";
import { runMain } from "../utils/process";
import { addSecretsToRpcUrl, removeSecretsFromRpcUrl } from "../utils/rpc/remove-secrets-from-rpc-url";

const logger = rootLogger.child({ module: "show-used-rpc-config", component: "main" });

async function main() {
  const chain = "ethereum" as Chain;
  const cmdParams = {
    client: {} as any,
    rpcCount: "all" as const,
    task: "historical" as const,
    includeEol: true,
    filterChains: [chain],
    filterContractAddress: null,
    forceCurrentBlockNumber: null,
    forceRpcUrl: null,
    forceGetLogsBlockSpan: null,
    productRefreshInterval: null,
    loopEvery: null,
    ignoreImportState: true,
    disableWorkConcurrency: true,
    generateQueryCount: null,
    skipRecentWindowWhenHistorical: "none" as const,
    waitForBlockPropagation: null,
  };

  const behaviour = _createImportBehaviourFromCmdParams(cmdParams);

  const rpcConfigs = getMultipleRpcConfigsForChain({ chain: chain, behaviour });
  const rpcConfig = rpcConfigs[0];
  const provider = rpcConfig.linearProvider;

  const multicallAddress = getBeefyMulticallAddress(chain);

  // you can use any ethers provider context here this example is
  // just shows passing in a default provider, ethers hold providers in
  // other context like wallet, signer etc all can be passed in as well.
  const multicall = new Multicall({ ethersProvider: provider, tryAggregate: true, multicallCustomContractAddress: multicallAddress });

  const vaults = [
    "0x83BE6565c0758f746c09f95559B45Cfb9a0FFFc4",
    "0xCc19786F91BB1F3F3Fd9A2eA9fD9a54F7743039E",
    "0x5Bcd31a28D77a1A5Ef5e0146Ab91e6f43D7100b7",
  ];

  const calls: ContractCallContext[] = [];
  for (const vaultAddress of vaults) {
    const ppfsAbi = {
      inputs: [],
      name: "getPricePerFullShare",
      outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
      stateMutability: "view",
      type: "function",
    };
    const reference = vaultAddress.toLocaleLowerCase();
    calls.push({
      reference: reference,
      contractAddress: vaultAddress,
      abi: [ppfsAbi] as any[],
      calls: [{ reference: reference, methodName: "getPricePerFullShare", methodParameters: [] }],
    });
  }

  const res = await multicall.call(calls, { blockNumber: ethers.utils.hexValue(16896415) });
  console.dir(res);

  /*
      {"level":10,"time":1679651295285,"module":"utils","component":"ethers","msg":"RPC request","data":{"request":{"method":"eth_call","params":[{"to":"0x9da9f3c6c45f1160b53d395b0a982aeee1d212fe","data":"0x399542e9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000016000000000000000000000000083be6565c0758f746c09f95559b45cfb9a0fffc40000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000477c7b8fc00000000000000000000000000000000000000000000000000000000000000000000000000000000cc19786f91bb1f3f3fd9a2ea9fd9a54f7743039e0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000477c7b8fc000000000000000000000000000000000000000000000000000000000000000000000000000000005bcd31a28d77a1a5ef5e0146ab91e6f43d7100b70000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000477c7b8fc00000000000000000000000000000000000000000000000000000000"},"0x101d19f"],"id":42,"jsonrpc":"2.0"},"rpcUrl":"https://rpc.ankr.com/eth/<RPC_API_KEY_ANKR>"}}
      {"level":50,"time":1679651295826,"module":"process","component":"exit-handler","err":{"type":"Error","message":"missing revert data in call exception; Transaction reverted without a reason string [ See: https://links.ethers.org/v5-errors-CALL_EXCEPTION ] (data=\"0x\", transaction={\"to\":\"0x9dA9f3C6c45F1160b53D395b0A982aEEE1D212fE\",\"data\":\"0x399542e9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000016000000000000000000000000083be6565c0758f746c09f95559b45cfb9a0fffc40000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000477c7b8fc00000000000000000000000000000000000000000000000000000000000000000000000000000000cc19786f91bb1f3f3fd9a2ea9fd9a54f7743039e0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000477c7b8fc000000000000000000000000000000000000000000000000000000000000000000000000000000005bcd31a28d77a1a5ef5e0146ab91e6f43d7100b70000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000477c7b8fc00000000000000000000000000000000000000000000000000000000\",\"accessList\":null}, error={\"reason\":\"processing response error\",\"code\":\"SERVER_ERROR\",\"body\":\"{\\\"jsonrpc\\\":\\\"2.0\\\",\\\"id\\\":42,\\\"error\\\":{\\\"code\\\":-32000,\\\"message\\\":\\\"execution reverted\\\"}}\",\"error\":{\"code\":-32000},\"requestBody\":\"{\\\"method\\\":\\\"eth_call\\\",\\\"params\\\":[{\\\"to\\\":\\\"0x9da9f3c6c45f1160b53d395b0a982aeee1d212fe\\\",\\\"data\\\":\\\"0x399542e9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000016000000000000000000000000083be6565c0758f746c09f95559b45cfb9a0fffc40000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000477c7b8fc00000000000000000000000000000000000000000000000000000000000000000000000000000000cc19786f91bb1f3f3fd9a2ea9fd9a54f7743039e0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000477c7b8fc000000000000000000000000000000000000000000000000000000000000000000000000000000005bcd31a28d77a1a5ef5e0146ab91e6f43d7100b70000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000477c7b8fc00000000000000000000000000000000000000000000000000000000\\\"},\\\"0x101d19f\\\"],\\\"id\\\":42,\\\"jsonrpc\\\":\\\"2.0\\\"}\",\"requestMethod\":\"POST\",\"url\":}
  */
}

runMain(main);
